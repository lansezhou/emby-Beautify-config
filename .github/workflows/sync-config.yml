name: Sync Config to Public Repo
on:
  push:
    paths:
      - 'config.yaml'  # 仅当 config.yaml 变更时触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 必须添加，否则无法获取 git 历史

      # 2. 设置 SSH 密钥用于 GitHub
      - name: Set up SSH key for GitHub
        run: |
          # 创建 SSH 配置目录
          mkdir -p ~/.ssh
          
          # 将 GitHub Secrets 中的 SSH 私钥写入 id_rsa 文件
          echo "${{ secrets.SSH_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          
          # 设置 id_rsa 文件的权限，防止权限问题
          chmod 600 ~/.ssh/id_rsa
          
          # 添加 GitHub 的公钥到 known_hosts，防止第一次连接时出现警告
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # 3. 强制将私有仓库的内容同步到公共仓库
      - name: Sync to Public Repo
        run: |
          # 设置目标仓库 URL
          TARGET_REPO="git@github.com:lansezhou/emby-Beautify-config.git"

          # 获取私有仓库的最新内容
          git fetch origin

          # 确保在最新的基础上重置当前分支
          git reset --hard origin/main

          # 将私有仓库的内容推送到公共仓库
          git push $TARGET_REPO main --force

        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}  # 确保密钥传递

